<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recording Controls</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent !important;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        height: 100vh;
        width: 100vw;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
        width: 100%;
        padding: 8px;
        padding-bottom: 6px;
      }

      .container.position-bottom {
        justify-content: flex-start;
      }

      .container.position-bottom .controls-bar {
        order: -1;
      }

      .action-buttons {
        display: none;
        gap: 6px;
        margin-bottom: 6px;
        animation: fadeIn 0.2s ease;
      }

      .action-buttons.visible {
        display: flex;
      }

      .position-bottom .action-buttons {
        margin-bottom: 0;
        margin-top: 6px;
      }

      .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 7px 12px;
        background: rgba(40, 40, 40, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
      }

      .action-btn:hover {
        background: rgba(60, 60, 60, 0.9);
        border-color: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .action-btn:active {
        transform: scale(0.97);
      }

      .action-btn.primary {
        background: rgba(102, 126, 234, 0.85);
        border-color: rgba(102, 126, 234, 0.4);
      }

      .action-btn.primary:hover {
        background: rgba(85, 104, 211, 0.95);
      }

      .action-btn.success {
        background: rgba(16, 185, 129, 0.85);
        border-color: rgba(16, 185, 129, 0.4);
      }

      .action-btn svg {
        width: 12px;
        height: 12px;
      }

      .action-btn.uploading {
        background: rgba(80, 80, 80, 0.7);
        cursor: not-allowed;
      }

      .action-btn .btn-spinner {
        width: 10px;
        height: 10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }

      .error-msg {
        display: none;
        font-size: 10px;
        color: #ff6b6b;
        margin-bottom: 4px;
        text-align: center;
        padding: 0 8px;
      }

      .error-msg.visible {
        display: block;
      }

      .controls-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        background: rgba(25, 25, 25, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        padding: 8px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        user-select: none;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }

      .controls-bar.draggable {
        cursor: grab;
        -webkit-app-region: drag;
      }

      .controls-bar.draggable:active {
        cursor: grabbing;
      }

      .controls-bar.draggable button,
      .controls-bar.draggable .action-btn {
        -webkit-app-region: no-drag;
      }

      .drag-handle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 0;
        opacity: 0;
        overflow: hidden;
        transition: width 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        margin-right: 0;
      }

      .controls-bar.draggable .drag-handle {
        width: 12px;
        opacity: 0.5;
        margin-right: 8px;
      }

      .controls-bar.draggable .drag-handle:hover {
        opacity: 0.8;
      }

      .drag-dots {
        display: grid;
        grid-template-columns: repeat(2, 4px);
        grid-template-rows: repeat(3, 4px);
        gap: 2px;
      }

      .drag-dots span {
        width: 3px;
        height: 3px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
      }

      .top-progress {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(60, 60, 60, 0.4);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .top-progress.visible {
        opacity: 1;
      }

      .top-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.15s ease-out;
      }

      .recording-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .recording-dot {
        width: 8px;
        height: 8px;
        background: #ff4757;
        border-radius: 50%;
        animation: pulse 1.2s ease-in-out infinite;
        box-shadow: 0 0 8px rgba(255, 71, 87, 0.5);
      }

      .recording-dot.ready {
        animation: none;
        background: #f1c40f;
        box-shadow: 0 0 8px rgba(241, 196, 15, 0.5);
      }

      .recording-dot.paused {
        animation: none;
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
      }

      .recording-dot.error {
        animation: none;
        background: #f44336;
        box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
      }

      .timer {
        font-family: "SF Mono", "Monaco", "Consolas", "Menlo", monospace;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        min-width: 38px;
        font-weight: 500;
        font-variant-numeric: tabular-nums;
      }

      .audio-meter {
        width: 4px;
        height: 20px;
        background: rgba(60, 60, 60, 0.6);
        border-radius: 2px;
        overflow: hidden;
        display: flex;
        flex-direction: column-reverse;
        opacity: 0;
        transition: opacity 0.3s ease, width 0.3s ease;
      }

      .audio-meter.visible {
        opacity: 1;
      }

      .meter-bar {
        width: 100%;
        height: 0%;
        background: linear-gradient(
          to top,
          #10b981 0%,
          #10b981 60%,
          #f1c40f 80%,
          #ff4757 100%
        );
        border-radius: 2px;
        transition: height 0.05s ease-out;
      }

      .control-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(255, 71, 87, 0.9);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .control-btn:hover {
        background: rgba(255, 47, 63, 1);
        transform: scale(1.08);
      }

      .control-btn:active {
        transform: scale(0.95);
      }

      .control-btn:disabled {
        background: rgba(80, 80, 80, 0.6);
        cursor: not-allowed;
        transform: none;
      }

      .control-btn.start-btn {
        background: rgba(16, 185, 129, 0.9);
      }

      .control-btn.start-btn:hover {
        background: rgba(5, 150, 105, 1);
        transform: scale(1.08);
      }

      .start-icon {
        width: 0;
        height: 0;
        border-left: 8px solid #fff;
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
        margin-left: 2px;
      }

      .control-btn .btn-spinner {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }

      .mic-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .mic-btn.muted {
        background: rgba(80, 80, 80, 0.8);
      }

      .mic-btn.unmuted {
        background: rgba(76, 175, 80, 0.9);
      }

      .mic-btn:hover {
        transform: scale(1.08);
      }

      .mic-btn.muted:hover {
        background: rgba(100, 100, 100, 0.9);
      }

      .mic-btn.unmuted:hover {
        background: rgba(67, 160, 71, 1);
      }

      .mic-btn:active {
        transform: scale(0.95);
      }

      .mic-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
      }

      .mic-btn svg {
        width: 14px;
        height: 14px;
        stroke: white;
        stroke-width: 2;
        fill: none;
      }

      .mic-btn.muted .mic-icon-on {
        display: none;
      }

      .mic-btn.muted .mic-icon-off {
        display: block;
      }

      .mic-btn.unmuted .mic-icon-on {
        display: block;
      }

      .mic-btn.unmuted .mic-icon-off {
        display: none;
      }

      .speaker-icon-on,
      .speaker-icon-off {
        width: 14px;
        height: 14px;
        stroke: white;
        stroke-width: 2;
        fill: none;
      }

      .mic-btn.muted .speaker-icon-on {
        display: none;
      }

      .mic-btn.muted .speaker-icon-off {
        display: block;
      }

      .mic-btn.unmuted .speaker-icon-on {
        display: block;
      }

      .mic-btn.unmuted .speaker-icon-off {
        display: none;
      }

      .stop-icon {
        width: 10px;
        height: 10px;
        background: #fff;
        border-radius: 2px;
      }

      .close-button {
        display: none;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(60, 60, 60, 0.8);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .close-button.visible {
        display: flex;
      }

      .close-button:hover {
        background: rgba(80, 80, 80, 0.9);
      }

      .close-button svg {
        width: 12px;
        height: 12px;
        stroke: rgba(255, 255, 255, 0.7);
        stroke-width: 2;
      }

      /* Rerecord Button */
      .rerecord-button {
        display: none;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(60, 60, 60, 0.8);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .rerecord-button.visible {
        display: flex;
      }

      .rerecord-button:hover {
        background: rgba(102, 126, 234, 0.9);
        transform: scale(1.08);
      }

      .rerecord-button:active {
        transform: scale(0.95);
      }

      .rerecord-button svg {
        width: 14px;
        height: 14px;
        stroke: rgba(255, 255, 255, 0.9);
        stroke-width: 2;
      }

      /* Gear Button */
      .gear-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(60, 60, 60, 0.8);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .gear-btn:hover {
        background: rgba(80, 80, 80, 0.9);
        transform: scale(1.08);
      }

      .gear-btn:active {
        transform: scale(0.95);
      }

      .gear-btn.active {
        background: rgba(102, 126, 234, 0.9);
      }

      .gear-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
      }

      .gear-btn svg {
        width: 14px;
        height: 14px;
        stroke: rgba(255, 255, 255, 0.85);
        stroke-width: 1.5;
        fill: none;
        transition: transform 0.3s ease;
      }

      .gear-btn.active svg {
        transform: rotate(90deg);
      }

      /* Settings Panel */
      .settings-panel {
        display: none;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 6px;
        opacity: 0;
        transform: translateY(8px);
        pointer-events: none;
      }

      .settings-panel.visible {
        display: flex;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
        animation: fadeIn 0.2s ease;
      }

      .settings-row {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(30, 30, 30, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .row-label {
        font-size: 10px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 55px;
      }

      .row-buttons {
        display: flex;
        gap: 4px;
      }

      .setting-opt {
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(60, 60, 60, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .setting-opt:hover {
        background: rgba(80, 80, 80, 0.7);
        color: rgba(255, 255, 255, 0.9);
      }

      .setting-opt.active {
        background: rgba(102, 126, 234, 0.85);
        border-color: rgba(102, 126, 234, 0.5);
        color: #fff;
      }

      .position-bottom .settings-panel {
        margin-bottom: 0;
        margin-top: 8px;
        order: 1;
      }

      .processing-status {
        background: rgba(25, 25, 25, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        gap: 6px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 10px;

        margin-bottom: 6px;
      }

      .processing-status.visible {
        display: flex;
      }

      .position-bottom .processing-status {
        margin-bottom: 0;
        margin-top: 6px;
      }

      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(60, 60, 60, 0.5);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(0.9);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container" id="container">
      <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
          <span class="row-label">Quality</span>
          <div class="row-buttons">
            <button class="setting-opt" data-type="quality" data-value="low">
              Low
            </button>
            <button
              class="setting-opt active"
              data-type="quality"
              data-value="medium"
            >
              Medium
            </button>
            <button class="setting-opt" data-type="quality" data-value="high">
              High
            </button>
          </div>
        </div>
        <div class="settings-row">
          <span class="row-label">FPS</span>
          <div class="row-buttons">
            <button class="setting-opt" data-type="fps" data-value="24">
              24
            </button>
            <button class="setting-opt active" data-type="fps" data-value="30">
              30
            </button>
            <button class="setting-opt" data-type="fps" data-value="60">
              60
            </button>
          </div>
        </div>
        <div class="settings-row">
          <span class="row-label">Cursor</span>
          <div class="row-buttons">
            <button
              class="setting-opt"
              data-type="showCursor"
              data-value="false"
            >
              Off
            </button>
            <button
              class="setting-opt active"
              data-type="showCursor"
              data-value="true"
            >
              On
            </button>
          </div>
        </div>
      </div>

      <div class="action-buttons" id="actionButtons">
        <button class="action-btn" id="btnCopy" title="Copy to clipboard">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path
              d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
            ></path>
          </svg>
          Copy
        </button>
        <button
          class="action-btn primary"
          id="btnUpload"
          title="Upload to internet"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Upload
        </button>
      </div>

      <div class="error-msg" id="errorMsg"></div>

      <div class="processing-status" id="processingStatus">
        <div class="spinner"></div>
        <span>Processing...</span>
      </div>

      <div class="controls-bar">
        <div class="drag-handle" id="dragHandle">
          <div class="drag-dots">
            <span></span><span></span> <span></span><span></span> <span></span
            ><span></span>
          </div>
        </div>
        <div class="top-progress" id="topProgress">
          <div class="top-progress-fill" id="topProgressFill"></div>
        </div>
        <div class="recording-indicator">
          <div class="recording-dot" id="recordingDot"></div>
          <span id="recLabel">REC</span>
        </div>
        <div class="timer" id="timer">0:00</div>
        <div class="audio-meter" id="audioMeter">
          <div class="meter-bar" id="meterBar"></div>
        </div>
        <button class="mic-btn muted" id="micButton" title="Toggle microphone">
          <svg class="mic-icon-on" viewBox="0 0 24 24">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
            <line x1="12" y1="19" x2="12" y2="23" />
            <line x1="8" y1="23" x2="16" y2="23" />
          </svg>
          <svg class="mic-icon-off" viewBox="0 0 24 24">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
            <line x1="12" y1="19" x2="12" y2="23" />
            <line x1="8" y1="23" x2="16" y2="23" />
            <line x1="2" y1="2" x2="22" y2="22" stroke-width="2.5" />
          </svg>
        </button>
        <button
          class="mic-btn unmuted"
          id="systemAudioButton"
          title="Toggle system audio"
        >
          <svg class="speaker-icon-on" viewBox="0 0 24 24">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
          </svg>
          <svg class="speaker-icon-off" viewBox="0 0 24 24">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
            <line x1="23" y1="9" x2="17" y2="15" stroke-width="2" />
            <line x1="17" y1="9" x2="23" y2="15" stroke-width="2" />
          </svg>
        </button>
        <button class="gear-btn" id="gearButton" title="Settings">
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            />
          </svg>
        </button>
        <button
          class="control-btn start-btn"
          id="startButton"
          title="Start recording"
        >
          <div class="start-icon"></div>
        </button>
        <button
          class="control-btn"
          id="stopButton"
          title="Stop recording"
          style="display: none"
        >
          <div class="stop-icon"></div>
        </button>
        <button
          class="rerecord-button"
          id="rerecordButton"
          title="Re-record (R)"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </button>
        <button class="close-button" id="closeButton" title="Close (ESC)">
          <svg viewBox="0 0 24 24" fill="none">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <script>
      const { ipcRenderer, clipboard } = require("electron");

      const container = document.getElementById("container");
      const startButton = document.getElementById("startButton");
      const stopButton = document.getElementById("stopButton");
      const closeButton = document.getElementById("closeButton");
      const rerecordButton = document.getElementById("rerecordButton");
      const timerElement = document.getElementById("timer");
      const recordingDot = document.getElementById("recordingDot");
      const recLabel = document.getElementById("recLabel");
      const processingStatus = document.getElementById("processingStatus");
      const actionButtons = document.getElementById("actionButtons");
      const btnCopy = document.getElementById("btnCopy");
      const btnUpload = document.getElementById("btnUpload");
      const topProgress = document.getElementById("topProgress");
      const topProgressFill = document.getElementById("topProgressFill");
      const errorMsg = document.getElementById("errorMsg");
      const micButton = document.getElementById("micButton");
      const systemAudioButton = document.getElementById("systemAudioButton");
      const gearButton = document.getElementById("gearButton");
      const settingsPanel = document.getElementById("settingsPanel");

      let isMicEnabled = false;
      let isSystemAudioEnabled = true;
      let recordingState = "ready";
      let isSettingsOpen = false;
      let currentSettings = { fps: 30, quality: "medium", showCursor: true };

      const uploadBtnOriginalHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload`;

      let startTime = null;
      let timerInterval = null;
      let videoPath = "";
      let uploadedUrl = null;
      let isRecording = false;
      let canClose = true;

      let audioContext = null;
      let analyser = null;
      let microphone = null;
      let animationId = null;
      const audioMeter = document.getElementById("audioMeter");
      const meterBar = document.getElementById("meterBar");

      async function startAudioMeter() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          microphone = audioContext.createMediaStreamSource(stream);

          analyser.fftSize = 256;
          analyser.smoothingTimeConstant = 0.8;
          microphone.connect(analyser);

          audioMeter.classList.add("visible");
          updateMeter();
        } catch (err) {
          console.log("Could not access microphone:", err);
        }
      }

      function updateMeter() {
        if (!analyser) return;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        const level = Math.min(100, (average / 128) * 100);

        meterBar.style.height = level + "%";

        animationId = requestAnimationFrame(updateMeter);
      }

      function stopAudioMeter() {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        if (microphone) {
          microphone.disconnect();
          microphone = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        analyser = null;
        audioMeter.classList.remove("visible");
        meterBar.style.height = "0%";
      }

      // Initial state: ready (yellow, ready to record)
      function initReadyState() {
        recordingState = "ready";
        recordingDot.classList.add("ready");
        recLabel.textContent = "WAITING";
        timerElement.textContent = "0:00";
        startButton.style.display = "flex";
        stopButton.style.display = "none";
        closeButton.classList.add("visible");
        canClose = true;
      }

      initReadyState();

      function updateTimer() {
        if (!startTime) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerElement.textContent = `${minutes}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }

      async function initMicStatus() {
        const status = await ipcRenderer.invoke("get-microphone-status");
        isMicEnabled = status.useMicrophone;
        updateMicUI();
      }

      function updateMicUI() {
        if (isMicEnabled) {
          micButton.classList.remove("muted");
          micButton.classList.add("unmuted");
          micButton.title = "Microphone on";
          startAudioMeter();
        } else {
          micButton.classList.remove("unmuted");
          micButton.classList.add("muted");
          micButton.title = "Microphone off";
          stopAudioMeter();
        }
      }

      micButton.addEventListener("click", async () => {
        // Only allow microphone change in ready state
        if (recordingState !== "ready") return;

        const result = await ipcRenderer.invoke("toggle-microphone");
        isMicEnabled = result.useMicrophone;
        updateMicUI();
      });

      async function initSystemAudioStatus() {
        const status = await ipcRenderer.invoke("get-system-audio-status");
        isSystemAudioEnabled = status.useSystemAudio;
        updateSystemAudioUI();
      }

      function updateSystemAudioUI() {
        if (isSystemAudioEnabled) {
          systemAudioButton.classList.remove("muted");
          systemAudioButton.classList.add("unmuted");
          systemAudioButton.title = "System audio on";
        } else {
          systemAudioButton.classList.remove("unmuted");
          systemAudioButton.classList.add("muted");
          systemAudioButton.title = "System audio off";
        }
      }

      systemAudioButton.addEventListener("click", async () => {
        // Only allow system audio change in ready state
        if (recordingState !== "ready") return;

        const result = await ipcRenderer.invoke("toggle-system-audio");
        isSystemAudioEnabled = result.useSystemAudio;
        updateSystemAudioUI();
      });

      initMicStatus();
      initSystemAudioStatus();
      initSettings();

      async function initSettings() {
        const settings = await ipcRenderer.invoke("get-settings");
        if (settings) {
          currentSettings = settings;
          updateSettingsUI();
        }
      }

      function updateSettingsUI() {
        document.querySelectorAll(".setting-opt").forEach((btn) => {
          const type = btn.dataset.type;
          const value = btn.dataset.value;
          const isActive =
            (type === "fps" && parseInt(value) === currentSettings.fps) ||
            (type === "quality" && value === currentSettings.quality) ||
            (type === "showCursor" &&
              (value === "true") === currentSettings.showCursor);
          btn.classList.toggle("active", isActive);
        });
      }

      function toggleSettings() {
        if (recordingState !== "ready") return;

        isSettingsOpen = !isSettingsOpen;
        settingsPanel.classList.toggle("visible", isSettingsOpen);
        gearButton.classList.toggle("active", isSettingsOpen);
      }

      gearButton.addEventListener("click", toggleSettings);

      settingsPanel.addEventListener("click", async (e) => {
        const btn = e.target.closest(".setting-opt");
        if (!btn) return;

        const type = btn.dataset.type;
        const value = btn.dataset.value;

        btn.parentElement.querySelectorAll(".setting-opt").forEach((b) => {
          b.classList.remove("active");
        });
        btn.classList.add("active");

        if (type === "fps") {
          currentSettings.fps = parseInt(value);
        } else if (type === "quality") {
          currentSettings.quality = value;
        } else if (type === "showCursor") {
          currentSettings.showCursor = value === "true";
        }

        await ipcRenderer.invoke("set-settings", currentSettings);
      });

      // Event: user clicks start recording button
      startButton.addEventListener("click", () => {
        if (recordingState !== "ready") return;

        recordingState = "starting";
        canClose = false;

        if (isSettingsOpen) {
          isSettingsOpen = false;
          settingsPanel.classList.remove("visible");
          gearButton.classList.remove("active");
        }

        startButton.disabled = true;
        startButton.innerHTML = '<div class="btn-spinner"></div>';
        micButton.classList.add("disabled");
        systemAudioButton.classList.add("disabled");
        gearButton.classList.add("disabled");
        closeButton.classList.remove("visible");
        recLabel.textContent = "STARTING...";

        ipcRenderer.send("start-recording-clicked");
      });

      ipcRenderer.on("recording-started", () => {
        recordingState = "recording";
        isRecording = true;
        canClose = false;

        recordingDot.classList.remove("ready");
        recLabel.textContent = "REC";

        startButton.style.display = "none";
        startButton.disabled = false;
        startButton.innerHTML = '<div class="start-icon"></div>';
        stopButton.style.display = "flex";
        closeButton.classList.remove("visible");

        micButton.classList.add("disabled");
        systemAudioButton.classList.add("disabled");
        gearButton.style.display = "none";

        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
      });

      function closeOverlay() {
        if (canClose) {
          stopAudioMeter();
          if (recordingState === "ready") {
            ipcRenderer.send("cancel-recording-overlay");
          } else {
            ipcRenderer.send("close-recording-overlay");
          }
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeOverlay();
        }
      });

      ipcRenderer.on("position-side", (event, side) => {
        if (side === "bottom" || side === "inside-top") {
          container.classList.add("position-bottom");
        }
      });

      ipcRenderer.on("controls-expanded", (event, side) => {
        container.style.opacity = "1";
      });

      stopButton.addEventListener("click", () => {
        if (!isRecording) return;

        isRecording = false;

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        recordingDot.classList.add("paused");
        recLabel.textContent = "OK";
        stopButton.disabled = true;

        processingStatus.classList.add("visible");

        // Enable drag immediately when stopping
        const controlsBar = document.querySelector(".controls-bar");
        controlsBar.classList.add("draggable");
        ipcRenderer.send("enable-window-drag");

        ipcRenderer.send("expand-controls");
        ipcRenderer.send("stop-recording-clicked");
      });

      ipcRenderer.on("recording-finished", (event, data) => {
        console.log("[CONTROLS] recording-finished received:", data);
        videoPath = data.path;
        canClose = true;

        stopAudioMeter();
        processingStatus.classList.remove("visible");
        actionButtons.classList.add("visible");
        closeButton.classList.add("visible");
        rerecordButton.classList.add("visible");
        stopButton.style.display = "none";
      });

      ipcRenderer.on("recording-error", (event, data) => {
        console.log("[CONTROLS] recording-error received:", data);
        canClose = true;

        stopAudioMeter();
        processingStatus.classList.remove("visible");
        recordingDot.classList.remove("paused");
        recordingDot.classList.add("error");
        recLabel.textContent = "ERROR";

        errorMsg.textContent = data.error || "Unknown error";
        errorMsg.classList.add("visible");

        closeButton.classList.add("visible");
        rerecordButton.classList.add("visible");
        stopButton.style.display = "none";

        const controlsBar = document.querySelector(".controls-bar");
        controlsBar.classList.add("draggable");
        ipcRenderer.send("enable-window-drag");
      });

      btnCopy.addEventListener("click", async () => {
        try {
          errorMsg.classList.remove("visible");
          const originalHtml = btnCopy.innerHTML;
          btnCopy.disabled = true;

          await ipcRenderer.invoke("copy-file-to-clipboard", videoPath);

          btnCopy.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> OK`;
          btnCopy.classList.add("success");

          setTimeout(() => {
            btnCopy.innerHTML = originalHtml;
            btnCopy.classList.remove("success");
            btnCopy.disabled = false;
          }, 1500);
        } catch (e) {
          errorMsg.textContent = e.message;
          errorMsg.classList.add("visible");
          btnCopy.disabled = false;
        }
      });

      btnUpload.addEventListener("click", async () => {
        if (uploadedUrl) {
          clipboard.writeText(uploadedUrl);
          btnUpload.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!`;
          btnUpload.classList.add("success");
          btnUpload.classList.remove("primary");

          setTimeout(() => {
            btnUpload.innerHTML = uploadBtnOriginalHtml;
            btnUpload.classList.remove("success");
            btnUpload.classList.add("primary");
          }, 1500);
          return;
        }

        try {
          errorMsg.classList.remove("visible");

          btnUpload.innerHTML = `<div class="btn-spinner"></div> Uploading...`;
          btnUpload.classList.add("uploading");
          btnUpload.classList.remove("primary");
          btnUpload.disabled = true;
          btnCopy.disabled = true;

          topProgress.classList.add("visible");
          topProgressFill.style.width = "0%";

          const result = await ipcRenderer.invoke(
            "upload-to-catbox",
            videoPath
          );

          uploadedUrl = result.url;
          clipboard.writeText(uploadedUrl);

          topProgress.classList.remove("visible");
          btnUpload.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!`;
          btnUpload.classList.remove("uploading");
          btnUpload.classList.add("success");
          btnCopy.disabled = false;

          setTimeout(() => {
            btnUpload.innerHTML = uploadBtnOriginalHtml;
            btnUpload.classList.remove("success");
            btnUpload.classList.add("primary");
            btnUpload.disabled = false;
          }, 1500);
        } catch (e) {
          topProgress.classList.remove("visible");
          btnUpload.innerHTML = uploadBtnOriginalHtml;
          btnUpload.classList.remove("uploading");
          btnUpload.classList.add("primary");
          btnUpload.disabled = false;
          btnCopy.disabled = false;
          errorMsg.textContent = e.message;
          errorMsg.classList.add("visible");
        }
      });

      ipcRenderer.on("upload-progress", (event, progress) => {
        topProgressFill.style.width = progress + "%";
      });

      // Processing progress handler
      ipcRenderer.on("processing-progress", (event, data) => {
        const { stage, percent } = data;

        // Show progress bar
        topProgress.classList.add("visible");
        topProgressFill.style.width = percent + "%";

        // Update status text based on stage
        const statusSpan = processingStatus.querySelector("span");
        switch (stage) {
          case "preparing":
            statusSpan.textContent = "Preparing...";
            break;
          case "rendering":
            statusSpan.textContent = "Rendering cursor...";
            break;
          case "compositing":
            statusSpan.textContent = "Compositing video...";
            break;
          case "done":
            statusSpan.textContent = "Done!";
            topProgress.classList.remove("visible");
            break;
          default:
            statusSpan.textContent = "Processing...";
        }
      });

      closeButton.addEventListener("click", closeOverlay);

      // Re-record button: restart the recording flow
      rerecordButton.addEventListener("click", () => {
        stopAudioMeter();
        ipcRenderer.send("rerecord-clicked");
      });

      // Keyboard shortcut for re-record
      document.addEventListener("keydown", (e) => {
        if (e.key === "r" || e.key === "R") {
          if (rerecordButton.classList.contains("visible")) {
            stopAudioMeter();
            ipcRenderer.send("rerecord-clicked");
          }
        }
      });
    </script>
  </body>
</html>
